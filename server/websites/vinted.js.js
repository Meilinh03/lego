const axios = require('axios');
const cheerio = require('cheerio');
const { v5: uuidv5 } = require('uuid');
const fs = require('fs');

// Code pour le scraping avec des cookies et en-têtes prédéfinis
const scrapeWithCookies = async (searchText) => {
  try {
    console.log('with cookies');
    const response = await fetch("https://www.vinted.fr/api/v2/catalog/items?page=1&per_page=96&time=1741632688&search_text=42182&catalog_ids=&size_ids=&brand_ids=&status_ids=&color_ids=&material_ids=", {
    "headers": {
        "accept": "application/json, text/plain, /",
        "accept-language": "fr",
        "priority": "u=1, i",
        "sec-ch-ua": "\"Not(A:Brand\";v=\"99\", \"Google Chrome\";v=\"133\", \"Chromium\";v=\"133\"",
        "sec-ch-ua-arch": "\"x86\"",
        "sec-ch-ua-bitness": "\"64\"",
        "sec-ch-ua-full-version": "\"133.0.6943.127\"",
        "sec-ch-ua-full-version-list": "\"Not(A:Brand\";v=\"99.0.0.0\", \"Google Chrome\";v=\"133.0.6943.127\", \"Chromium\";v=\"133.0.6943.127\"",
        "sec-ch-ua-mobile": "?0",
        "sec-ch-ua-model": "\"\"",
        "sec-ch-ua-platform": "\"Windows\"",
        "sec-ch-ua-platform-version": "\"10.0.0\"",
        "sec-fetch-dest": "empty",
        "sec-fetch-mode": "cors",
        "sec-fetch-site": "same-origin",
        "x-anon-id": "e0ece9ee-f6a7-4ef8-962e-be0a13d8cdc5",
        "x-csrf-token": "75f6c9fa-dc8e-4e52-a000-e09dd4084b3e",
        "x-money-object": "true",
        "cookie": "v_udt=ajE5bk45S0tPSEYzcHoxTVUyWTBDOTl6R1d3Mi0tazdDUFRMczRxQzZ2S0c5YS0telFEM2JGM0FIaVVPeEFPNDUwVnVUdz09; anonymous-locale=fr; anon_id=e0ece9ee-f6a7-4ef8-962e-be0a13d8cdc5; anon_id=e0ece9ee-f6a7-4ef8-962e-be0a13d8cdc5; OptanonAlertBoxClosed=2025-03-10T17:38:05.383Z; eupubconsent-v2=CQODSZgQODSZgAcABBENBgFsAP_gAAAAAChQJwtX_G__bXlj8X71aftkeY1f99h7rsQxBgbJk-4FyLvW_JwX32E7NAz6pqYKmRIAu3TBIQNlHIDURUCgaogVrSDMaEyUoTNKJ6BkiFMRY2cYCFxvm4lDeQCY5vr991d52R-t7dr83dzyy4hHv3a5_2S1WJCdAYctDfv9bROb-9IOd_x8v4v4_FgAAAAAABAAAAAAAAAAAAAAAAAAABYAAACwkEEABAAC4AKAAqABwADwAIIAZABqADwAIgATAAqgBvAD0AH4AQkAhgCJAEcAJYATQArQBhwDKAMsAbIA74B7AHxAPsA_QCAAEUgIuAjABGgCggFQAKuAXMAxQBogDaAG4AOIAh0BIgCdgFDgKPAUiApsBbAC5AF3gLzAYaAyQBk4DLgGcwNYA1kBsYDbwG6gOTAcuA8cB7QEIQIXhADoADgASADnAIOAT8BHoCRQErAJtAU-AsIBeQDEAGLQMhAyMBowDUwG0ANuAboA8oB8gD9wICAQMggiCCYEGAIVgQuHALwAEQAOAA8AC4AJAAfgBoAHOAO4AgEBBwEIAJ-AVAAvQB0gEIAI9ASKAlYBMQCZQE2gKQAUmArsBagDEAGLAMhAZMA0YBpoDUwGvANoAbYA24Bx8DnQOfAeUA-IB9sD9gP3AgeBBECDAEGwIVjoJYAC4AKAAqABwAEAALoAZABqADwAIgATAAqwBcAF0AMQAbwA9AB-gEMARIAjgBLACaAFGAK0AYYAygBogDZAHeAPaAfYB-wEUARgAoIBVwCxAFzALyAYoA2gBuADiAHUAQ6Ai8BIgCZAE7AKHAUfApoCmwFWALFAWwAuABcgC7QF3gLzAX0Aw0BjwDJAGTgMqgZYBlwDOQGqgNYAbeA3UBxYDkwHLgPHAe0A-sCAIELSABMABAAaABzgFiAR6Am0BSYC8gGpgNsAbcA58B5QD4gH7AQPAgwBBsCFZCA2AAsACgALgAqgBcADEAG8APQA7wCKAEpAKCAVcAuYBigDaAHUgU0BTYCxQFogLgAXIAycBnIDVQHjgQtJQIwAEAALAAoABwAHgARAAmABVAC4AGKAQwBEgCOAFGAK0AbIA7wB-AFXAMUAdQBDoCLwEiAKPAU2AsUBbAC8wGTgMsAZyA1gBt4D2gIHkgB4AFwB3AEAAKgAj0BIoCVgE2gKTAYsA3IB5QD9wIIgQYKQNgAFwAUABUADgAIIAZABoADwAIgATAAqgBiAD9AIYAiQBRgCtAGUANEAbIA74B9gH6ARYAjABQQCrgFzALyAYoA2gBuAEOgIvASIAnYBQ4CmwFigLYAXAAuQBdoC8wF9AMNAZIAyeBlgGXAM5gawBrIDbwG6gOTAeOA9oCEIELSgCAAC4AJABHADnAHcAQAAkQBYgDXgHbAP-Aj0BIoCYgE2gKQAU-ArsBeQDFgGTANTAa8A8oB8UD9gP3AgYBA8CCYEGAINgQrLQAQFNgAA.f_wAAAAAAAAA; OTAdditionalConsentString=1~43.46.55.61.70.83.89.93.108.117.122.124.135.143.144.147.149.159.192.196.211.228.230.239.259.266.286.291.311.318.320.322.323.327.367.371.385.394.407.415.424.430.436.445.486.491.494.495.522.523.540.550.559.560.568.574.576.584.587.591.737.802.803.820.821.839.864.899.904.922.931.938.979.981.985.1003.1027.1031.1040.1046.1051.1053.1067.1092.1095.1097.1099.1107.1135.1143.1149.1152.1162.1166.1186.1188.1205.1215.1226.1227.1230.1252.1268.1270.1276.1284.1290.1301.1307.1312.1345.1356.1375.1403.1415.1416.1421.1423.1440.1449.1455.1495.1512.1516.1525.1540.1548.1555.1558.1570.1577.1579.1583.1584.1591.1603.1616.1638.1651.1653.1659.1667.1677.1678.1682.1697.1699.1703.1712.1716.1721.1725.1732.1745.1750.1765.1782.1786.1800.1810.1825.1827.1832.1838.1840.1842.1843.1845.1859.1866.1870.1878.1880.1889.1899.1917.1929.1942.1944.1962.1963.1964.1967.1968.1969.1978.1985.1987.2003.2008.2027.2035.2039.2047.2052.2056.2064.2068.2072.2074.2088.2090.2103.2107.2109.2115.2124.2130.2133.2135.2137.2140.2147.2156.2166.2177.2186.2205.2213.2216.2219.2220.2222.2225.2234.2253.2279.2282.2292.2305.2309.2312.2316.2322.2325.2328.2331.2335.2336.2337.2343.2354.2358.2359.2370.2376.2377.2387.2400.2403.2405.2407.2411.2414.2416.2418.2425.2440.2447.2461.2465.2468.2472.2477.2481.2484.2486.2488.2493.2498.2501.2510.2517.2526.2527.2532.2535.2542.2552.2563.2564.2567.2568.2569.2571.2572.2575.2577.2583.2584.2596.2604.2605.2608.2609.2610.2612.2614.2621.2628.2629.2633.2636.2642.2643.2645.2646.2650.2651.2652.2656.2657.2658.2660.2661.2669.2670.2677.2681.2684.2687.2690.2695.2698.2713.2714.2729.2739.2767.2768.2770.2772.2784.2787.2791.2792.2798.2801.2805.2812.2813.2816.2817.2821.2822.2827.2830.2831.2834.2838.2839.2844.2846.2849.2850.2852.2854.2860.2862.2863.2865.2867.2869.2873.2874.2875.2876.2878.2880.2881.2882.2883.2884.2886.2887.2888.2889.2891.2893.2894.2895.2897.2898.2900.2901.2908.2909.2916.2917.2918.2919.2920.2922.2923.2927.2929.2930.2931.2940.2941.2947.2949.2950.2956.2958.2961.2963.2964.2965.2966.2968.2973.2975.2979.2980.2981.2983.2985.2986.2987.2994.2995.2997.2999.3000.3002.3003.3005.3008.3009.3010.3012.3016.3017.3018.3019.3028.3034.3038.3043.3052.3053.3055.3058.3059.3063.3066.3068.3070.3073.3074.3075.3076.3077.3089.3090.3093.3094.3095.3097.3099.3100.3106.3109.3112.3117.3119.3126.3127.3128.3130.3135.3136.3145.3150.3151.3154.3155.3163.3167.3172.3173.3182.3183.3184.3185.3187.3188.3189.3190.3194.3196.3209.3210.3211.3214.3215.3217.3219.3222.3223.3225.3226.3227.3228.3230.3231.3234.3235.3236.3237.3238.3240.3244.3245.3250.3251.3253.3257.3260.3270.3272.3281.3288.3290.3292.3293.3296.3299.3300.3306.3307.3309.3314.3315.3316.3318.3324.3328.3330.3331.3531.3731.3831.4131.4531.4631.4731.4831.5231.6931.7235.7831.7931.8931.9731.10231.10631.10831.11031.11531.12831.13632.13731.14034.14237.14332.15731.16831.16931.21233.23031.25131.25731.25931.26031.26831.27731.27831.28031.28731.28831.29631.32531.33631.34231.34631.36831.39131.39531.40632.41531; _gcl_au=1.1.493791692.1741628286; _lm_id=DN2M5SJIHHXUZ2Q; _ga=GA1.1.466958018.1741628286; _fbp=fb.1.1741628286507.293459107382025399; domain_selected=true; __gads=ID=40f6b800a6066261:T=1741628344:RT=1741630219:S=ALNI_Ma7S3H9O_T3v--rlh1ZT5jSllNMNA; __eoi=ID=28dd3bea9157616e:T=1741628344:RT=1741630219:S=AA-AfjbPQn4U_XUplNX4hWm-kd2h; viewport_size=447; cto_bundle=zl959l9ab2JDZHM5TWtLZDEzUm9lOE5EbUR5eTZrRHloQmZJcGdQTHVseVBaVyUyQlVReEZScXRaMk9zbTNjc3FCTWRGeTg0JTJGSGlPTTNYZUFDM0gzUThHOG5PenpyZG8wQVJ2SG81RGtIVDEwSFE4dCUyQmdCTFRLUExGdFh5MkwweldlbktuQk9xWm1KR2FxZHlDMjB2aGZzdk1iTnclM0QlM0Q; __cf_bm=bPK7n5XooMTSok2KY.mJdP9hYMh48LBZE6vz9m2CAGM-1741632630-1.0.1.1-UBdR2Nrl_vrbR8q2YzVyishMM9s4SsE5nWaAZFC7Ls_GwTyMyIM2MVR3125D.9oscq8Xg4IE9hCMYlxcvdtJwkM4HuOjx3o1vyiOoSsJIouFks_TascmrKbiiSkctMiB; _ga_8H12QY46R8=GS1.1.1741632667.2.0.1741632667.0.0.0; _ga_ZJHK1N3D75=GS1.1.1741632667.2.0.1741632667.0.0.0; access_token_web=eyJraWQiOiJFNTdZZHJ1SHBsQWp1MmNObzFEb3JIM2oyN0J1NS1zX09QNVB3UGlobjVNIiwiYWxnIjoiUFMyNTYifQ.eyJhcHBfaWQiOjQsImNsaWVudF9pZCI6IndlYiIsImF1ZCI6ImZyLmNvcmUuYXBpIiwiaXNzIjoidmludGVkLWlhbS1zZXJ2aWNlIiwiaWF0IjoxNzQxNjMyNjcyLCJzaWQiOiIxYjk0NThlNi0xNzQxNjIzNzg5Iiwic2NvcGUiOiJwdWJsaWMiLCJleHAiOjE3NDE2Mzk4NzIsInB1cnBvc2UiOiJhY2Nlc3MifQ.xDDZSKOuimLMY71AJW9KI7JFXTGEUjyPnSCLUaukTAGKAE3LdA4aJ4Un_53E41_Iq7S4BZdflGnbVuclNSaLdp7yGp4e4Ygw7cyMMXIgSkui0t1fkjTP7JDgK-2NtDT-ceCy_PNkSRiIzO9X2U7fwWRtOtG1O4RtuwRtP8lz9oU4d8ES0hSL8AUtyDzOSGAfozZa4RFd9s5JofBJ6pWMbgGjkN-7wKm5qxGH2wJ1tIiWnMXt6fU2cEDsE92dbOxUqpnBl0IZeOOxckicS-g7_v40spxsQ1-x-UeN-XUCQDrCjjvDa3VW_oBEip4lXbTbc5LrUNg-pG7k0EyT4BXa2w; refresh_token_web=eyJraWQiOiJFNTdZZHJ1SHBsQWp1MmNObzFEb3JIM2oyN0J1NS1zX09QNVB3UGlobjVNIiwiYWxnIjoiUFMyNTYifQ.eyJhcHBfaWQiOjQsImNsaWVudF9pZCI6IndlYiIsImF1ZCI6ImZyLmNvcmUuYXBpIiwiaXNzIjoidmludGVkLWlhbS1zZXJ2aWNlIiwiaWF0IjoxNzQxNjMyNjcyLCJzaWQiOiIxYjk0NThlNi0xNzQxNjIzNzg5Iiwic2NvcGUiOiJwdWJsaWMiLCJleHAiOjE3NDIyMzc0NzIsInB1cnBvc2UiOiJyZWZyZXNoIn0.B58vX6-RBIf7dsk3dDyDqOrYmOzsaf5cycrEggnNdTqUIpRn_wig3OBsZjl-Bj-uK5K8RGyOu2ruHq0u86L-zBBqiXOnfENcmKnSKMkL8tgy8FJ9iSCpBiPV3bRQdSZOS9J1ee2AoqIvht85TYOczKD2rKb-MtQINTMBAQ_xnQOahBPyMueEYfTOpISIE_n6mUEc9yPt9dH5S_TrRIrKUHyq59x_2xPTXT9aBnFVfZFotmy7CHwO-Vu6IszOuyNuE3fYPgSj3AdHiJ9PfWMdUBrHh1AC-kaL9X2qVPAFDPWjtZzMRsVYcegrmEbkvHzz-8oIdi_Gdnyu7AKOo6Wz1A; _dd_s=rum=2&id=d905e7ee-5ac8-42bd-824f-a899e736e6bf&created=1741628285415&expire=1741633574128; v_sid=1b9458e6-1741623789; cf_clearance=9.0ycr.1zU13L8AhF3vfUoTi5PZWN3qXkGvouJQdAHM-1741632684-1.2.1.1-EghFrvoDZ_wwU.R8xWgsyYO.Yx_AAc.JrJutccIUiOVhze2_Ugj4K6JdOGtXoY2l4HlDwR.VGwaNyk1hHx02nJ0HDlixg1dlNaJ0xiSqvtVsBx9vb3MSPfIBrcDJDReh8.hFfO81DRFDjKaY1roNvfWNEQx4z.AjyPDy6CshqXA93xJtgYBJp41HpNY0kN3fe0qzYcf8ARsDLE.CiFc3YbIAbkGJrtBT8_gS8aYQKJ.WkXSgggW1JB3dP1I0XCoiqd_I3SYbvaGcZ1SXNHIDLeT.lMpmHHFZo6RthW9yi9nXO.SerdPACBfLTkSfvzJzZRuedQClELQvGIe3a4n_3s0tPaBloWuyoyeon9g3fZs; OptanonConsent=isGpcEnabled=0&datestamp=Mon+Mar+10+2025+19%3A52%3A02+GMT%2B0100+(heure+normale+d%E2%80%99Europe+centrale)&version=202312.1.0&browserGpcFlag=0&isIABGlobal=false&consentId=e0ece9ee-f6a7-4ef8-962e-be0a13d8cdc5&interactionCount=10&hosts=&landingPath=NotLandingPage&groups=C0001%3A1%2CC0002%3A1%2CC0003%3A1%2CC0004%3A1%2CC0005%3A1%2CV2STACK42%3A1%2CC0015%3A1%2CC0035%3A1&genVendors=V2%3A1%2CV1%3A1%2C&geolocation=FR%3B&AwaitingReconsent=false; _vinted_fr_session=eWVxRnVUd3hLUXM3Z1poN3BkTWo2TFVEZkMxN0dxV2RuU1NmLzNIODVTRXRJc1JwaWNZVVFJemhOOENGWnlMSGtwK2FlaGRUbUtRMTRONDJ6SGg5T2FDNU9Td2dmeEpielNjNVhrMzQvWW1ZTHNXQ1JSTmZlOTIxZ2VhVzBsTDRoVFdvRUQ3T0g0V25UNDdIRWtjSlF1Z2JYUTlQeXlOR0dwY1ZlakFkYkYwWkMxQklVaS9kVWtaYnRVMVdURmlKQmV2dW5PcXVudmdpcU5ZWUZXTlpYd2tpcFQ2aGJPVjZacGFkTlBLUC9wOUFqV2hXSjBaYU16U0ZzOXFFOWI0N1dMcEtDd0dhY2s2VkpYY0Nqd0dGZVVLaWh6N2syTm1Bc2JmTVlxOFkzdnFCajlsYmJBMWVCTU9PNEJEVnhYZkFtODIzY2I4SzQ1RkVuc3l6UVRyWlNHbFJBSWtQTy9VQ0R1WEJFMTRnYVVSQllzeXRaSklRbVQ3OWcweXNZc0lJc3RIQmVadUlldURsZTA0K29qaDgvb3FJNExkRzdreXZwelYwMjZMSXEvQUQ5SzB2R1pUdnAxendlVzVFQTJEandzOThWOVRLc2F3T1lWSVZ1bTVTcXFHZGFrWFBkeU1WUWVKbjlObUptMDBMV05uVkZCMVlIcGRXeHlLZkNIMjZwMy9PWUlFUHorTy9WaUFaYzJnWVhZbHRTV1ZFeUttdjJ5TlIxenZ0SDVsRUNTa1hEcG16TXhPMm82MmxTRnQ3Z3dXRlVxTzFCTDlhM2FPT3dSQTc4ZnF0MkJzMHhERlYyQTNuSUxIaWxlT1hjS1pLM3VrblJpV0N2RjBXT1NWd2YwL1pZRllSZUl6Y3J0RjdDaUtQdUlWbVM5bXBCYWE0Wmt2bjBVYXlqZUszZHowOVY3bE4rdXVkdEdwbjEvTno1V0s0Y1FwUE1JUWJoaW5vM0hMUnIrbFY2VFBSQ1lMcEJGcHV6cDZudmVEUVlWeHBZRDBUVTl3M0xNYVA3czcwdVpGSVJWalVSY0dKRmN0a0xNRW14VHJhWUhXTllRY2FFWGlGd3NGY0txaERiNy90SkgveTBBNVlFSDl1RjI5Mi9oTnREQXowOHhyWHIyRnNJY2VRdGV3YllTaVFmcmtHUVBrUUYxWlhUd2trQVZsaVF5U2dvRFJwRUpYVS9OUVdJVk11WVlHNTVqVjJvQmZ4VmRQN2M5amRJY0VpaVpYL0V3S1E4Tmtzd1NVM1Z2YjVNbjQ5UzRUdVVOUlJYQWprd0ducGhVUys5eWFENTk1Q1kxQlZMb1FxQXk4b0o0V1h1a0NpcU9TYkx5VXBmeG1ENzQzZENnaXFUcmo5akdITWZxV3huNnQ3VHhyOTUyNlF3Y24zQlRWbWtrUWxsUURvVnJEaE10a2xvVCtPM0VBZW9ENU5yLzhhb0ZveDRjMEVZQk9pbkZWQW1EUFozajFjazZKSEl5SFl0S2c4MmpYV2tKcEowaGJDNHkzTjZMbUpLbERJTTZIMTlOeWFZSXRoMlhMd0hxbU1pM1Q5VG9xa1N3a0dlejBQYy9jYzcreFVhY243cmJCby9VcjZOdGI4aWZFT1JSb1JVOWRuN1YzZ1Z5VkFhVFFYUHMwTHBTaEJuUk1rTGVQY3FLb2J4OXZ2Zm5SSGJVU0lsUWVBbjBsa0JvZ3dpajRrVlZXdG1kVlJ3THJJcVNZa2pQZm9helE1bzVKazNVb3ZIV1pmNlVnak1ZYU5GRzg0VVpvMTUxaWVpRXNBSDVtOUVTTnJ6OUIzZ05aNW5jekZxazdRUndXejkyVmxDSXl0UEk5RXdSWGU0TjZueGpOTko3NGRudEIrNUVGeDVuKzVlZkpkNzhnK3dIejlzTC9EOFlVTTFtMUNPc2ZSeVBTSHpOVHQzS2hPcUFqZ2NWQWhCdEZDcUpSMVl4ZTFraFdZZG9Na1RHZll5cTJyNFhxTFZPbFFHQkdHRmlPbnRzUUVhOUVuMWFzcEVlb2tKbDZNWjhMbHU1N09DOGVVODZ4UnpKelBaZDZuVVpycEZDOERSZ3VBaDlSeE1NQjdNOStJZFBxMkx0TURONjArWEZvTTc4Z3kyTWFsdEwxZVIrQjNlanVtTHN1UlRBcU8vVm1vV2JRWHkxQUVKRXk1T29XUGpWdzRUUkdiZVBNNjZ6MzNBMFR3WnNyZmVQSktOTUx1UFVrWFNkSWJiL2xKOUtTSmQ1dXZ6TVlHNVk1dEQ3YVZKODl2MW1EcGs4cnpVbkhKNmhLT2IzY25zMnVBME8zazJ3a2dXYnV0S1owNUFLekdrL2hhRkRyelRPSnV0VU1uWGtiUUxaSkxieWlLN2JGZS9EeDlIM2lnRGhMUVVuTENzL080VzhwYi0tZ3RnTVByRDMvaER0WjhkcmFqcUVkdz09--01eca44e631addfd68ffc735a85bb8870831c8bc; datadome=6_W_TV7EmTN8YYDTyhvMRHzl1JBV8gA~8Mvtv_jEPH4r0l3D1qtbXJDARwr0HyJlLhgra8EmFeVTsVX3GypSnOKvfADFjxP4aU4yHxc55fkdlgPusp8NBJPWHnyBClv~; banners_ui_state=PENDING",
        "Referer": "https://www.vinted.fr/catalog?search_text=42182&page=1&time=1741632688",
        "Referrer-Policy": "strict-origin-when-cross-origin"
  },
  "body": null,
  "method": "GET"
});
    if (response.ok) {
      const body = await response.json();
      const items = body.items; // Accéder au tableau des articles

      if (items && items.length > 0) {
        const extractedItems = items.map((item) => {
          return {
            title: item.title,
            price: item.price,
            currency: item.currency,
            url: item.link, // Construire l'URL complète
            photo: item.photo.url, // URL de la photo
            // Ajoutez d'autres propriétés que vous souhaitez extraire
          };
        });

        console.log(extractedItems); // Afficher les articles extraits
        
      } else {
        console.log('Aucun article trouvé.');
      }
    } else {
    console.error(`Erreur HTTP : ${response.status}`);
    }
  } catch (error) {
    console.error('Erreur lors du scraping :', error);
  }
};

scrapeWithCookies('lego'); 

module.exports.scrape = async url => {
  const response = await fetch(url);

  if (response.ok) {
    const body = await response.text();

    return parse(body);
  }

  console.error(response);

  return null;
};

